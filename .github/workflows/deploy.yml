name: Deploy to VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 2239
        script: |
          # Navigate to app directory
          sudo mkdir -p /opt/cloud-cost-mlops
          sudo chown -R $USER:$USER /opt/cloud-cost-mlops
          cd /opt/cloud-cost-mlops
          
          # Stop existing services
          pkill -f "streamlit\|mlflow\|uvicorn" || true
          
          # Clone/update repository
          if [ -d ".git" ]; then
            git pull origin main
          else
            rm -rf *
            git clone https://github.com/${{ github.repository }} .
          fi
          
          # Install dependencies
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-venv net-tools
          
          # Create virtual environment
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          
          # Create directories
          mkdir -p data/raw mlruns logs
          
          # Start services with virtual environment
          source venv/bin/activate
          export TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          export TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          nohup python -m streamlit run ui/app.py --server.port 8501 --server.address 0.0.0.0 > logs/streamlit.log 2>&1 &
          nohup mlflow ui --host 0.0.0.0 --port 5000 > logs/mlflow.log 2>&1 &
          nohup python -m uvicorn api.main:app --host 0.0.0.0 --port 8000 > logs/api.log 2>&1 &
          
          echo "Deployment completed. Services starting..."
          sleep 5
          
          # Check if services are running
          pgrep -f streamlit && echo "Streamlit: Running" || echo "Streamlit: Failed"
          pgrep -f mlflow && echo "MLflow: Running" || echo "MLflow: Failed"
          pgrep -f uvicorn && echo "API: Running" || echo "API: Failed"
